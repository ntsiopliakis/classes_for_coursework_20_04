<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Очень простой планировщик на примере CortexM0</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Очень простой планировщик на примере CortexM0</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="Img/pixiz-04-06-2020-11_04_02.jpg" alt="pixiz 04 06 2020 11 04 02">
</div>
</div>
<div class="paragraph">
<p>С каждым годом курсовые для моих студентов становятся все объемнее. Например, в этом году, одним из заданий было - разработка метеостации, ведь только ленивый не делает метеостанции, а студенты они по определению не ленивые, поэтому должны её сделать. Её можно быстро накидать в Cube или собрать на Ардуино, но задача курсового не в этом. Основная задача - самостоятельно, с нуля разобраться с модулями микроконтроллера, продумать архитектуру ПО, и собственно закодировать все на С++.
Кому интересно, вот пример отчета по такому курсовому. FIXME</p>
</div>
<div class="paragraph">
<p>Так вот появилась небольшая проблема, а именно, бесплатный IAR позваоляет делать ПО размером не более 30 кБайт. А это уже впритык к размеру курсового в неоптимизированном виде. Анализ кода студентов выявил, что примерно 1/4 часть их приложения занимает FreeRtos - около 6 кБайт, хотя для того, чтобы сделать вытесняющую переключалку и управлялку задачами хватило бы, наверное&#8230;&#8203; да байт 500 причем вместе с 3 задачами (светодиодными моргунчиками).</p>
</div>
<div class="paragraph">
<p>Эта статья будет посвещена тому как реализовать Очень Простой Планировщик, описанный в статье аж 2006 году <a href="https://www.embedded.com/build-a-super-simple-tasker/" class="bare">https://www.embedded.com/build-a-super-simple-tasker/</a> и сейчас реализованный <a href="http://www.state-machine.com/products/">Quantum Leaps</a> в продукте <a href="http://www.state-machine.com/qpcpp/">Qp framework</a>.</p>
</div>
<div class="paragraph">
<p>С помощью этого ядра очень просто реализовать конечный автомат, и оно очень хорошо может использоваться в небольших проектах студентами, которые могут получить дополнительно 5 кБайт в свое распоряжение.</p>
</div>
<div class="paragraph">
<p>Я попробую показать, как можно реализовать такой планировщик самому. Чтобы не сильно перегружать статью, расмотрю переключение контекста на CortexMO у которого нет аппаратного модуля с плавающей точкой.</p>
</div>
<div class="paragraph">
<p>Кому интересно это, а также как вообще переключается контекст, добро пожаловать под кат.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Вы можете спросить, а зачем вообще тут RTOS - ответ прост, для обучения, для понимания, для упрощения архитектуры и самого ПО. Да и вообще
при разработке ПО под микроконтроллеры, особенно, если это что-то серьезнее, чем моргание светодоидом, часто приходится иметь дело с многоздачностью.
А еще также часто приходится обеспечивать как можно более быстрый отклик на некоторые события, например, истечение таймера, прерывание от аппаратного модуля, прием данных и так далее. По другому это называется обеспечивать режим реального времени.

И вот для этого(и не только для этого) программисты встроенного ПО используют Операционные системы реального времени, типа FreeRTOS. И это хорошо, но бывает так, что использование операционной системы влечет за собой необоснованный расход ресурсов микроконтрллера (ОЗУ - ведь каждая задача требует свой стек, поднятие частоты процессора из-за медленного переключения контекста, ПЗУ - такие RTOS универсальны и иногда подключается куча ненужных для вашей скромной задачи сервисов).</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_небольшое_отступление">Небольшое отступление</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Изначально я хотел описать как работает планировщик в обычных РТОС и потом уже описать, как он сделан в Простом планировщике, а также показать пример такого планировщика на ядре CortexM4, но статья получалась довольно большоей и не понятной, поэтому вот наши начальные условия:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Рассматриваем только CortexM0, ну или процы с ARM архитектурой поддерживающие только</p>
<div class="ulist">
<ul>
<li>
<p>Thumb набор команд</p>
</li>
<li>
<p>Имеющие только прилигированный режим</p>
</li>
<li>
<p>Не имющие аппаратного блока с плавающей точкой</p>
</li>
</ul>
</div>
</li>
<li>
<p>Используем только основной стек <strong>MSP</strong></p>
</li>
<li>
<p>Считаем, что микроконтроллер имеет как минимум двухстадийный конвейер</p>
</li>
<li>
<p>Не используем указатели</p>
</li>
<li>
<p>Не используем виртуальных функций (абстрактных класслв), только статический полиморфизм</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>И хотя такой планировщик впринципе можно запустить и на CortexM3 и даже на CortexM4 (с отключенным FPU блоком), для нормальной их поддержки, нужно будет внести небольшие изменения в обработчике PendSV и SVC.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_введение">Введение</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Собственно, в качестве введения наверное лучше всего подойдет цитата из выше указанной статьи 2006 года</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Большую часть времени встроенные системы ждут какого-то события, такого как тик времени, нажатие кнопки, готовности АЦП или получения пакета данных. После распознавания события системы реагируют, выполняя соответствующие вычисления. Эта реакция может включать в себя работу с аппартными модулями или создание вторичных событий бизнес логики, которые запускают другие внутренние функкции. После завершения действия по обработке событий такие  системы переходят в спящее состояние в ожидании следующего события.
&#160;<br></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Большинство RTOS для встроенных систем вынуждают программистов моделировать эти простые, дискретные реакции на события, используя задачи, разработанные как непрерывные бесконечные циклы.</p>
</div>
<div class="paragraph">
<p>По большому счету, вся программа  - это один большой или небольшой конечный автомат. И наши старшие братья в мире ПО под "нормальные" операционные системы давно уже имеют кучу механизмов для реализации конечных автоматов - потоки, корутины, фиберы - тому поддверждение. В ПО же для микроконтроллеров же каждый раз приходится либо использовать совсем неоптимальные вещи обычных операционных систем реального времени (передача событий от задачи к задаче, со всеми вытекающими (долгие переключения контеста, создание новых задач с большими стеками)), либо городить что-то свое, либо по старинке пользоваться обычным switchом.</p>
</div>
<div class="paragraph">
<p>В случае же с SST ядро и планировщик очень просты и ему не нужно управлять несколькими стеками. И основное отличие этого ядра является то, что оно требует чтобы все задачи выполнялись до заверщения (Run to completion), используя один стек.
А это кстати решает одну из "вечных" проблем, ведь бесконечный цикл в С это вообще-то UB. Нет таких циклов - нет UB, а заодно сделаем наш планировщик без единого указателя, чтобы, еще меньше UB проникли в код (не уверен, что код на С можно вообще написать без UB, но вдруг).</p>
</div>
<div class="paragraph">
<p>Но перед тем как начать рассказ, я хотел вначале найти простое объяснение, как переключить контекст в интернете, из более менее понятного - простого, это вот <a href="https://www.kit-e.ru/assets/files/pdf/2013_04_168.pdf" class="bare">https://www.kit-e.ru/assets/files/pdf/2013_04_168.pdf</a>. Но понять принцип переключения при первом чтении без заглядывания в руководство по ядру CortexM3 из этого текста не так просто.</p>
</div>
<div class="paragraph">
<p>Есть еще статья на Хабре: <a href="https://habr.com/ru/company/embox/blog/330236/">Как сделать context switch на STM32</a>.
Но даже если вы и прочитали эту статьи, то все равно, это выглядит как рисование совы.</p>
</div>
<div class="paragraph">
<p>Поэтому давайте вначале разберемся с алгоритмом переключения контекста, как это вообще происходит. И первым делом займемся изучением некоторых понятий</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_команды_cortexm_микроконтроллеров">Команды CortexM микроконтроллеров</h2>
<div class="sectionbody">
<div class="paragraph">
<p>У CortexM бывает три набора команд:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ARM</strong> - Основной набор 32 битный набор команд.</p>
</li>
<li>
<p><strong>Thumb</strong> — Cокращённая система 16 битных команд.</p>
</li>
<li>
<p><strong>Thumb-2</strong> - 16 битный thumb набор + немного 32 битных команд, эдакая смесь <strong>ARM</strong> и <strong>Thumb</strong>, чтобы получить преимущества обоих систем команд.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Так вот наш CortexM0 поддерживает только <strong>Thumb</strong> набор, ну не считая парочки команд из <strong>Thumb-2</strong> - закроем на это глаза.
На всякий случай, CortexM3 поддерживает <strong>Thumb-2</strong> полностью.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_режимы_работы_процессора">Режимы работы процессора.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cortex-M имеет два режима работы: режим процесса (<strong>Thread</strong>) и режим обработчика (<strong>Handle</strong>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Режим <strong>Handle</strong> используется при обработке исключительных ситуаций(обработчики прерываний) и работает только с основным <strong>MSP</strong> стеком</p>
</li>
<li>
<p>Режим <strong>Thread</strong> — для выполнения пользовательского кода и может работать с осноснвым стеком(<strong>MSP</strong>) или стеком процесса (<strong>PSP</strong>)
Переключение из одного режима в другой происходит автоматически.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Про стеки узнаем немного позже, а пока это вся информация по режимам, которую нужно знать для переключения контекста. И да, мы будет использовать только основной стек <strong>MSP</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cortexm0_регистры">CortexM0 регистры</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CortexM0 имеет 16 регистров общего назначения:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/registers.png" alt="registers">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Младшие регистры (r0-r7)</p>
</li>
<li>
<p>Старшие регистры (r8-r12),</p>
</li>
<li>
<p>Регистр указателья стека <strong>SP</strong> (r13) для текущего контекста</p>
<div class="ulist">
<ul>
<li>
<p>В зависимости от контекста может быть либо <strong>MSP</strong> (указателем основного стека) либо <strong>PSP</strong> ( указателем стека процесса). Но мы же не заморачиваемся, используем только <strong>MSP</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Регистр связи <strong>LR</strong> (r14)</p>
</li>
<li>
<p>Регистр счетчика команд <strong>PC</strong>(r15)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>И ряд регистров специального назначения:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Регистр состояния <strong>xPSR</strong>, он содержит в себе флаги результатов выполнения арфиметических дейтвий, состояние выполнение программы и номер обрабатываемого в данный момент исключения. Доступ к полям регистра может осуществляться через три псевдорегистра, позволяющие обращаться к определенным областям <strong>xPSR</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>Регистр состояния приложения <strong>APSR</strong> содержит флаги результатов выполнения арифметических операций</p>
</li>
<li>
<p>Регистр состояния прерывания <strong>EPSR</strong> содержит номер обрабатываемого исключения</p>
</li>
<li>
<p>Регистр состояния выполнения <strong>IPSR</strong> содержит бит показывающий в каком режиме исполняются команды микоконтроллера <strong>Thumb</strong> или <strong>ARM</strong>, а так как, мы выяснили, что
CortexM0 может работать только в <strong>Thumb</strong> режиме, то это бит всегда должен быть равено <strong>1</strong>, иначе микроконтроллер допустит недопустимое.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Регистр <strong>PRIMASK</strong>, в нем всего один бит, запрещающий все прерывания с конфигурируемым приоритетом</p>
</li>
<li>
<p>Регистр <strong>CONTROL</strong>, управляющий выбором режима (Прелигированный или нет(Это еще что такое? Да сколько этих режимов?, не волнуйтесь,  для CortexM0 режим всегда прилигированный, поэтому просто не обращайте на это внимаение)) и выбором стека (основной <strong>MSP</strong> или стек процесса <strong>PSP</strong>)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_регистр_указателя_стека_r13sp">Регистр указателя стека (r13/SP)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Я не буду подробно описывать что такое стек, есть множество статей на эту тему. Но для того, чтобы понять как он работает на CortexM архитектуре необходимо знать несколько моментов.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Указатель стека всегда выравнен по слову и его два младшие бита должны быть равны 0.</p>
</li>
<li>
<p>Стек всегда двигается от старших адресов к младшим.</p>
</li>
<li>
<p>Указатель стека используется для доступа к стеку с помощью интрукций <strong>POP</strong> и <strong>PUSH</strong>.</p>
</li>
<li>
<p>Укзатель стека может быть подифицирован с помощью инструкций  <strong>LDR</strong>, <strong>STR</strong>, <strong>SUB</strong>, <strong>ADD</strong> и так далее</p>
</li>
<li>
<p>Имеет двойное назначение и может являться:</p>
<div class="ulist">
<ul>
<li>
<p><strong>MSP</strong>(Main Stack Pointer) - указателем на основной стек,</p>
</li>
<li>
<p><strong>PSP</strong> (Programm Stack Pointer) - указателем на стек процесс PSP.<br></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>И хотя в нашей задаче нам не нужен стек процесса, для общего образования все таки уточню, что в каждый момент доступен только один из этих указателй. В режиме <strong>Handle</strong> указатель <strong>SP</strong> всегда указывает на <strong>MSP</strong>, а вот в режиме <strong>Thread</strong> указатель может указывать как на основной стек <strong>MSP</strong>, так и на стек процесса <strong>PSP</strong>. Какой именно сейчас стек используется, можно определить с помощью CONTROL регистра.</p>
</div>
<div class="paragraph">
<p>Выходя из режима <strong>Handle</strong> можно поменять стек указав волшебное значение в регистре связи. Встречаем регистр связи.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_регистр_свзязи_r14lr">Регистр свзязи (r14/LR)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>У регистра связи две функции. Одна прямая - хранение адреса возврата:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Регистр связи используется хранения адреса возврате из подпрограмм и функций, вызванных командой BL.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>И вторая не менее важная:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Во время входа и возврата из исключения в LR сохраняется EXC_RETURN код, который указывает какой режим и какой стек нужно использовать после возврата из исключения.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">EXC_RETURN</th>
<th class="tableblock halign-left valign-top">Что значит</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xFFFFFFF1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Возвращаемся в <strong>Handle</strong> режим, используем основной стек <strong>MSP</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xFFFFFFF9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Возвращаемся в <strong>Thread</strong> режим, используем основной стек <strong>MSP</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xFFFFFFFD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Возвращаемся в <strong>Thread</strong> режим, используем стек процесса <strong>PSP</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Как вы уже поняли, нам нужно значение 0xFFFFFFF9, так как мы всегда хотим работать с <strong>MSP</strong> стеком и мы его будем использовать.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_исключение">Исключение</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Исключение в ARM, это такой механизм, который позволяет прервать безмятежное течение программы. Исключение может быть вызвано программно с помощью инструкции вызова исключения или же вызвано в ответ на поведение системы, такое как прерывание, ошибка выравнивания или ошибка системы памяти.
Исключения бывают синхронные и ассинхронные. Прерывания являются ассинхронными исключениями. А вот например, например, ошибки связанные с доступом к памяти или выполнения инструкций - синхронные исключения.</p>
</div>
<div class="paragraph">
<p>И в целом разделяют две основные стадии исключения:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Генерация исключения</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Момент, когда в микроконтроллере происходит некое важное событие, которое  связано с исключением</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Обработка или активация исключения</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Это когда микроконтроллер начинает выполнять опредленную последовательность для входа в исключение, потом выполнение кода обработчика исключения и в конце последовательность выхода из исключения. И в общем-то переход от состояния генерации исключения до состояния обработка исключения может быть мнгоневенным.</p>
</div>
<div class="paragraph">
<p>А теперь давайте поймем как происходит вход и выход из исключения.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_кадр_исключения">Кадр исключения</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Для полноты картины нехватает еще одного понятия - Кадр исключения (Exception Frame). Так вот, это набор регистров, которые автоматически сохраняются при входе в исключение и восстанавливается из него при выходе из исключения. Кадр выглядит как - то так:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/exceptionframe.png" alt="exceptionframe">
</div>
</div>
<div class="paragraph">
<p>Сохраняются регистры R0-R3, R12 и LR, PC, xPSR.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_вход_в_исключение">Вход в Исключение</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Это важным момент для понимания того, что происходит во время вхождения и выхода из прерывания.
Вход в прерывание возникает тогда, когда появляется ожидающее исключение с необходимым приортетом и:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Микроконтроллер находится в <strong>Thread</strong> режиме</p>
</li>
<li>
<p>Исключение имеет приоритет выше, чем обрабатывающееся в данный момент исключение. В таком случае исключение с высшим приоритетом вытесняет текущее исключение, по другому это называется вложенными исключениями.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Когда микроконтроллер начинает обработку исключения он сохраняет кадр исключения в стеке. Эта операция по английски называется "stacking". По русски звучит странно, поэтому не буду переводить. При этом указатель стека перемещается на размер кадра исключения.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/stacking.png" alt="stacking">
</div>
</div>
<div class="paragraph">
<p>Как было уже сказано выше, стек исключения содержит кадр из 8 слов данных и подчиняется простым правилам.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Стек выравнивнен по 8 байтову адресу (двум словам).</p>
</li>
<li>
<p>Стек содержит адрес возврата из исключения  - адрес следующей инструкции в прерванной исключением подпрограмме. Это значение востанавливается и загружается в PC во время возврата из исключения.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Микроконтроллер, а точнее контроллер прерывания считывает стартовый адрес обработчика исключения из таблицы векторов прерываний.
Когда "stacking" завершен, микроконтроллер запускает выполнение обработчика прерывания. В то же время микроконтроллер записывает специальный код возврата - EXC_RETURN в регистр <strong>LR</strong>, как мы уже выяснили этот код показывает тип указателя стека (<strong>MSP</strong> или <strong>PSP</strong>) и в каком режиме был микроконтроллер до входа в исключение.</p>
</div>
<div class="paragraph">
<p>Если во время входа в исключение не произошло более высоко-приоритетного прерывания, процессор запускает выполнение обрабочика исключения. Микроконтоллер автоматически изменяет статус исключения на активное.</p>
</div>
<div class="paragraph">
<p>Если более высокоприоритеное исключение произошло во время входа в исключение, то текущее статус текущего исключения будет "ожидание". Так называемое "позднее прибытие".</p>
</div>
<div class="paragraph">
<p>Так, исключение обработали, теперь надо из него выйти.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_возврат_из_исключения">Возврат из исключения</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Возврат из иключения происходит когда микроконтроллер находистя в Handler режиме и  выполняется одна и следующих инструкций, пытающихся установить PC в специальное EXC_RETURN значение :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POP инструкция которая загружает значение из стека в <strong>PC</strong>.</p>
</li>
<li>
<p>BX инструкция, сипользущая любой регистр</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Микроконтроллер сохраянет значение EXC_RETURN в <strong>LR</strong> при входе в исключение
Механизм исключений полагается на это значение, чтобы определить когда микроконтроллер завершит обработку исключения.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Биты[31:4]</dt>
<dd>
<p>EXC_RETURN значения должны быть установлены в 0xFFFFFFF. Когда микроконтролер загружает эти биты в PC, это дает понять ядру, что операция не является обычной, а означает завершение обработки прерывания. Как результат такого "оповещения" запускается последовательность возврата из исключения.</p>
</dd>
<dt class="hdlist1">Биты[3:0]</dt>
<dd>
<p>EXC_RETURN  значения указывают на требуемый стек возврата и режим процессора.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>При возврате из исключения происходит обратная операция - unstacking, еще более странно переводящаяся на русский язык. При этом микроконтроллер загружает в  <strong>PC</strong> адрес следующей инструкции из кадра исключения, и собственно переходит на её исполнение, заодно из него же загружает новое значение регистра <strong>LR</strong>, по которому определяет какой стек надо использовать.</p>
</div>
<div class="paragraph">
<p>Я тут попытался нарисовать залипающаю картинку, получилось не очень, но не пропадать же 2-часову труду зря.
Залипающая картинка</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/stakingMsp.gif" alt="stakingMsp">
</div>
</div>
<div class="paragraph">
<p>Но я люублю статику, поэтому вот обычная картинка:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/Excpetion.png" alt="Excpetion">
</div>
</div>
</div>
</div>
<h1 id="_переключение_контекста" class="sect0">Переключение контекста</h1>
<div class="paragraph">
<p>Наконец-то вся теория изучена, осталось сделать собственно переключение контекста и вытесняющую многозадачность.</p>
</div>
<div class="paragraph">
<p>Все таки сделаю небольшое отступление:
В традиционных RTOS, идея работы с задачами состоит в том, чтобы PSP стек использовался отдельными задачами, а MSP стек использовался обработчиками исключений и ядром.  Когда возникает исключение, контекст задачи помещается в текущий активный указатель стека PSP, а затем переключается на использование MSP для обработки исключения.</p>
</div>
<div class="paragraph">
<p>После того, как планировщик сгенерировал исключение , например PendSV, вы должны сохранить указатель PSP стека на текущую задачу в стеке текущей задачи, загрузить из стека следующей задачи указатель стека в PSP и возвратиться уже в новую задачу.</p>
</div>
<div class="paragraph">
<p>С одной стороны это хорошо - это подразумевает некое разделение между стеками обработчика исключений и задач, ваша задача всегда работает со стеком PSP и доступа к MSP нет.</p>
</div>
<div class="paragraph">
<p>С другой стороны, переключение контектса не такое быстрое, а из-за того, что каждая задача имеет свой стек - дополнительный расход ОЗУ.</p>
</div>
<div class="paragraph">
<p>Итак контекст у нас должен переключаться по какому-то событию. Пусть это будет любое событие, происходящее в прерывании, например, по таймеру, или приходу символа в UART, или любому другому, которое должно инициировать обработку чего-то. Как только произошло такое событие мы должны запустить планировщик, который найдет подходяющую задачу и запустит её, при этом вытеснув уже запущенные менее приоритеные.</p>
</div>
<div class="paragraph">
<p>Логично, что такие события могут происходить из прерываний, т.е в режиме Handle, а вот планировщик и задачи должны быть запущены в режиме Thread. Как это сделать?</p>
</div>
<div class="paragraph">
<p>Каждый раз при выходе из любого прерывания в котором генеруется событие для переключения контекста мы будем генерировать исключение PendSV, и уже в нем делать магию по переключению контекста: Ну т.е. в упрощенном виде все будет это выглядеть примерно так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> OnTimerExpired()
 {
     Tasker::PostEvent&lt;targetThread&gt;(eventsToPost) ; <span style="color:#777">// Послать событие нужно задаче, в данном примере targerThread</span>
     Tasker::IsrExit() ;  <span style="color:#777">// Вызвать исключение PendSV для запуска планировщика и вытеснения текущей задачи</span>
 }
 .....
 <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> IsrExit()
 {
    SCB::ICSR::PENDSVSET::PendingState::Set();  <span style="color:#777">// Генерируем исключение PendSV</span>
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Т.е. вместо того, чтобы в прерывании вызвать планировщик, мы сгенерируем исключение PendSV и уже в нем запустим планировщик, который будет заниматься переключением задач.</p>
</div>
<div class="paragraph">
<p>Сразу же после выхода из прерывания, сгенерировшего событие для какой либо задачи, мы должны</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Скинуть флаг исключения PendSV,</p>
</li>
<li>
<p>Запретить все прерывания</p>
</li>
<li>
<p>Вызвать планировщик</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>На последнем пункте давайте остановимся поподробнее, потому легко сказать, да как это сделать&#8230;&#8203;</p>
</div>
<div class="sect1">
<h2 id="_вызов_планировщика">Вызов планировщика</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Итак, как вы помните при входе в исключение, микроконтроллер сохранил кадр исключения на стеке от текущей задачи. Если указатель стека так и останется на вершине этого кадра, то при вызове планировщика, этот кадр пропадет, так как при выходе из исключения сделается unstacking. Значит нам надо немного подредагтировать стек, чтобы, при вызове планировщика мы работали с другим кадром. Т.е. к текущему указателю стека нужно добавить (а посколько стек растет в сторону уменешения адресов, то убавить) стек на размер еще одного такого же кадра, но с данными для вызова Планировщика.</p>
</div>
<div class="paragraph">
<p>И в этот кадр мы в <strong>PC</strong> положим адрес планировщика, в <strong>LR</strong> адрес возврата после работы планировщика, а в xPSR надо будет поставить 1 в бит <strong>T</strong>, который говорит о том, что мы работает с набором команд Thumb, а то выйдет исключение по ошибке выполнения инструкций.</p>
</div>
<div class="paragraph">
<p>Вот так вот поменяется наш стек в обработчике исключения PendSV</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/newstack.png" alt="newstack">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_выозврат_из_планировщика">Выозврат из планировщика</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Как только планировщик выполнил свою работу, нам нужно вернуться куда-то, где надо будет разрешить прерывания, а также сделать, что-то, что позволит вернуться к текущей прерванной задаче. Т.е. мы опять должны будем сгенерировать какое-то исключение, и при в нем удалить тот кадр исключения, что мы добавили в предыдущем пункте. И уже при выходе из исключения, у нас сделается правильный unstacking с переходом на прерванную задачу.</p>
</div>
<div class="paragraph">
<p>Вот такую картинку я нарисовал, могут быть ошибки, но честно старался.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/switch.png" alt="switch">
</div>
</div>
<div class="paragraph">
<p>Ну а теперь все тоже самое в ассемблере</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="asm">  RSEG CODE:CODE:NOROOT(2)
  PUBLIC  HandlePendSv
  PUBLIC  HandleSvc
  EXTERN  Schedule

HandlePendSv:             // попадая в прерывание микроконтроллер сохранит exception frame

  LDR     r3,=0xE000ED04  // Загружаем адрес регистра ICSR
  LDR     r1,=1&lt;&lt;27       // Устанавливаем бит сброса флага прерывания PendSV

  CPSID   i              // Запрещаем прерывание

  STR     r1,[r3]        // Очищаем флаг прерывания PendSV в регистре ICSR
  LDR     r3,=1&lt;&lt;24      // устанавливаем T-bit,  который индицирует, что процессора находится в Thumb state. Наше едро работает только с набором команда Thumb, если он будет в 0, возникнет ошибка

  LDR     r2,=Schedule-1         //загружаем адрес планировщика - он должен быть четным
  LDR     r1,=ScheduleReturn     //и адрес возврата
  SUB     sp,sp,#8*4             //резервируем на стеке место под exception frame
  ADD     r0,sp,#5*4             //и перемещаемся в место для сохранения XPSR, PC, LR
  STM     r0!,{r1-r3}            // и сохраняем их r3- xPSR, R2 - PC, r1-LR
  LDR     r0,=0xFFFFFFF9         // Возрвращаемся в thread Mode из MSP стека в MSP стек
  BX      r0

ScheduleReturn:
  CPSIE   i                    // Возвращаемся из планировщика, разрешаем прерывания
  SVC #0                       // И инициируем прерываение SVC для возврата в поток,
                               // который превало PendSV
                               // Между командой разршения прерывания и герерации SVC
                               // чисто теоритически может вклиниться еще прерывание
                               // но у нас двух-стадийный конвейр и поэтому обе команды
                               // уже в нем, ничто не может прерывать вызов SVC
                               // но пацаны с Quantum Leaps используют тут генерацию NMI

HandleSvc:
  ADD     sp,sp,#(8*4)        // Удаляем место под exception frame, нам он больше не нужен,
                              // используем exception frame от PendSV
  BX      lr                  // возвращаемся к прерваному потоку.
  END</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_планировщик">Планировщик</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ну а теперь посмотрим, как устроен Ооочень простой планировщик.</p>
</div>
<div class="paragraph">
<p>Для простоты, мы сделаем так, чтобы приоритет задачи определялся её положением в списке задач Очень простого планировщика. Ну т.е., чтобы если мы задали бы так</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> myTasker: Tasker&lt;HighPriorityTask, NormalPriorityTask, LowPriorityTask,  idleTask&gt; {} ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>То это бы означало, что приоритет HighPriorityTask -  самый высокий, а idleTask - самый низкий. Это нам решит кучу проблем, с сортировкой списка задач. Задачи всегда расположены в порядке уменьшения приритета.</p>
</div>
<div class="paragraph">
<p>Тогда наш планировщик будет совсем совсем простым.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">  <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> Schedule()
  {
    <span style="color:#080;font-weight:bold">if</span>(preempted)
    {
      preempted = <span style="color:#069">false</span>;
      <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span> preemptedTaskId = activeTaskId; <span style="color:#777">// сохраним номер текущей задачи</span>
      <span style="color:#088;font-weight:bold">auto</span> nextTaskId = GetFirstActiveTaskId(); <span style="color:#777">// получить номер первой активной задачи</span>

      <span style="color:#777">// Если номер задачи меньше номера текущей задачи,</span>
      <span style="color:#777">// то у неё выше приоритет и её надо запустить</span>
      <span style="color:#080;font-weight:bold">while</span> (nextTaskId &lt; activeTaskId)
      {
        activeTaskId = nextTaskId;
        CallTask(nextTaskId); <span style="color:#777">// вызываем задачу и сбрасываем установленное событие</span>
        nextTaskId = GetFirstActiveTaskId(); <span style="color:#777">// вдруг есть еще активные задачи</span>
      }
      activeTaskId = preemptedTaskId; <span style="color:#777">//восстановим номер текущей задачи</span>
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Функция запуска задачи выглядит так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">__forceinline  <span style="color:#080;font-weight:bold">template</span>&lt;<span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span>&amp; task&gt;
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> CallTaskHelper()
{
  task.events = noEvents;   <span style="color:#777">// скидываем событие</span>
  __enable_interrupt() ;    <span style="color:#777">// разрешаем прерывание, чтобы задачу можно было вытеснить</span>
  task.OnEvent();           <span style="color:#777">// запускаем задачу</span>
  __disable_interrupt() ;   <span style="color:#777">// запрещаем снова прерывание</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Как видно, задача должна реализовывать метод OnEvent().
B да, мы же не хотели использовать указатели, поэтому задачи передаем через ссылки, как параметр шаблона.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">template</span>&lt;<span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span>&amp; ...tasks&gt;
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Tasker</span>
{
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>и пробегаемся по этому списку так, например, чтобы найти первую (самую высокоприоритетную) активную задачу:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">constexpr</span> size_t GetFirstActiveTaskId()
 {
   <span style="color:#080;font-weight:bold">return</span> GetFirstActiveTask&lt;tasks...&gt;(<span style="color:#00D">0</span>U);
 }

 __forceinline <span style="color:#080;font-weight:bold">template</span>&lt;<span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span>&amp; task, <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span>&amp; ...args&gt;
 <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">constexpr</span> size_t GetFirstActiveTask(size_t result)
 {
   <span style="color:#080;font-weight:bold">if</span> <span style="color:#088;font-weight:bold">constexpr</span> (<span style="color:#080;font-weight:bold">sizeof</span>...(args) != <span style="color:#00D">0</span>U)
   {
     <span style="color:#080;font-weight:bold">if</span> (task.events != noEvents)
     {
       <span style="color:#080;font-weight:bold">return</span> result;
     }
     <span style="color:#080;font-weight:bold">else</span>
     {
       <span style="color:#088;font-weight:bold">auto</span> res = result + <span style="color:#00D">1</span> ;
       <span style="color:#080;font-weight:bold">return</span> GetFirstActiveTask&lt;args...&gt;(res);
     }
   }
   <span style="color:#080;font-weight:bold">else</span>
   {
     <span style="color:#080;font-weight:bold">if</span> (task.events != noEvents)
     {
       <span style="color:#080;font-weight:bold">return</span> result;
     } <span style="color:#080;font-weight:bold">else</span>
     {
       <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>U;
     }
   }
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>и собтсвенно и запускаем на исполнение также</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> CallTask(size_t id)
{
  <span style="color:#080;font-weight:bold">return</span> CallTaskById&lt;tasks...&gt;(id, <span style="color:#00D">0</span>U);
}

__forceinline <span style="color:#080;font-weight:bold">template</span>&lt;<span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span>&amp; task, <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span>&amp; ...args&gt;
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> CallTaskById(size_t id, size_t result)
{
   <span style="color:#080;font-weight:bold">if</span> <span style="color:#088;font-weight:bold">constexpr</span> (<span style="color:#080;font-weight:bold">sizeof</span>...(args) != <span style="color:#00D">0</span>U)
   {
     <span style="color:#080;font-weight:bold">if</span> (result == id)
     {
       CallTaskHelper&lt;task&gt;() ;
     }
     <span style="color:#080;font-weight:bold">else</span>
     {
       <span style="color:#088;font-weight:bold">auto</span> res = result + <span style="color:#00D">1</span> ;
       CallTaskById&lt;args...&gt;(id, res);
     }
   }
   <span style="color:#080;font-weight:bold">else</span>
   {
     <span style="color:#080;font-weight:bold">if</span> (result == id)
     {
       CallTaskHelper&lt;task&gt;() ;
     }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Чтобы задача активировалась ей надо просигналить, ну например, случился таймаут link layerа у какого-нибудь протолока (да хоть Modbus) и надо обработать событие по приему сообщения - да ради бога - посылаем задаче, обработчика приема сообщения событие.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">  <span style="color:#080;font-weight:bold">template</span>&lt;<span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">auto</span>&amp; targetTask&gt;
  <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> PostEvent(<span style="color:#088;font-weight:bold">const</span> tStateEvents events)
  {
    <span style="color:#088;font-weight:bold">const</span> CriticalSection cs;
    targetTask.events |= events;  <span style="color:#777">// устанавливаем событие в задаче</span>
    preempted = <span style="color:#069">true</span>;
    <span style="color:#080;font-weight:bold">if</span> (scheduleLockedCounter == <span style="color:#00D">0</span>U) <span style="color:#777">// Если планировщик не запрещен</span>
    {
      Schedule(); <span style="color:#777">//Вдруг задачи которой послали событие имеет высший приоритет</span>
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Выше я уже указывал, что нельзя просто так взять и запустить планировщик из прерывания, нужно из этого прерывания как-то выйти вначале, а потом уже запустить - и это мы делаем путем вызова PendSV.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"> __forceinline <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> IsrEntry()
 {
   assert(scheduleLockedCounter != <span style="color:#00D">255</span>U);
   ++scheduleLockedCounter;
 }

 __forceinline <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> IsrExit()
 {
   assert(scheduleLockedCounter != <span style="color:#00D">0</span>U);
   --scheduleLockedCounter;
   SCB::ICSR::PENDSVSET::PendingState::Set(); <span style="color:#777">//</span>
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>В примере, я сделал события от таймеров, которые построил на основе системного таймера. Обработичик прерывания системного таймера показан ниже:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">template</span> &lt;<span style="color:#080;font-weight:bold">typename</span> Tasker, <span style="color:#080;font-weight:bold">typename</span> ...Timers&gt;
<span style="color:#080;font-weight:bold">struct</span> TaskerTimerService
{
  <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> OnSystemTick()
  {
     Tasker::IsrEntry() ;
     (Timers::OnTick(), ...) ;
     Tasker::IsrExit() ;
  }
} ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>А таймеры просто постят события</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">template</span> &lt;<span style="color:#088;font-weight:bold">auto</span>&amp; targetThread, std::uint32_t TimerFrequency, std::uint32_t msPeriod, tStateEvents eventsToPost, <span style="color:#080;font-weight:bold">typename</span> Tasker&gt;
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TaskerTimer</span>
{
<span style="color:#088;font-weight:bold">public</span>:
  <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> OnTick()
  {
    --ticksRemain ;
    <span style="color:#080;font-weight:bold">if</span> (ticksRemain == <span style="color:#00D">0</span>U)
    {
      ticksRemain = ticksReload ;
      Tasker::PostEvent&lt;targetThread&gt;(eventsToPost) ;
    }
  }
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для задач</p>
</div>
<div class="paragraph">
<p>Я сделал 3, нет 4 задачи, 3 из которых моргают светодиодами, а одна ничего не делает.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> TargetThread: <span style="color:#088;font-weight:bold">public</span> TaskBase&lt;TargetThread&gt;
{
    <span style="color:#088;font-weight:bold">void</span> OnEvent() <span style="color:#088;font-weight:bold">const</span>
    {
      <span style="color:#777">// Когда кто-то нам просигналил, мы переключим светодиод.</span>
      GPIOC::ODR::Toggle(<span style="color:#00D">1</span>&lt;&lt;<span style="color:#00D">8</span>);    <span style="color:#777">// светодиод PortC.8</span>
    }

};

<span style="color:#080;font-weight:bold">template</span>&lt;<span style="color:#080;font-weight:bold">typename</span> SimpleTasker, <span style="color:#088;font-weight:bold">auto</span>&amp; threadToSignal&gt;
<span style="color:#080;font-weight:bold">struct</span> Thread1 : <span style="color:#088;font-weight:bold">public</span> TaskBase&lt;Thread1&lt;SimpleTasker, threadToSignal&gt;&gt;
{
  <span style="color:#088;font-weight:bold">void</span> OnEvent() <span style="color:#088;font-weight:bold">const</span>
  {
    GPIOC::ODR::Toggle(<span style="color:#00D">1</span>&lt;&lt;<span style="color:#00D">9</span>);  <span style="color:#777">//светодиод PortC.9</span>
    SimpleTasker::PostEvent&lt;threadToSignal&gt;(<span style="color:#00D">1</span>); <span style="color:#777">// Посылаем сигнал какой-то другой задаче</span>
  }
};

<span style="color:#080;font-weight:bold">template</span>&lt;<span style="color:#080;font-weight:bold">typename</span> SimpleTasker, <span style="color:#088;font-weight:bold">auto</span>&amp; threadToSignal&gt;
<span style="color:#080;font-weight:bold">struct</span> Thread2 : <span style="color:#088;font-weight:bold">public</span> TaskBase&lt;Thread2&lt;SimpleTasker, threadToSignal&gt;&gt;
{
    <span style="color:#088;font-weight:bold">void</span> OnEvent() <span style="color:#088;font-weight:bold">const</span>
    {
        GPIOC::ODR::Toggle(<span style="color:#00D">1</span>&lt;&lt;<span style="color:#00D">5</span>); <span style="color:#777">// светодиод PortC.5</span>
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; <span style="color:#00D">4000000</span>; ++i)  <span style="color:#777">// имитация бурной деятельности</span>
        {
        };
        SimpleTasker::PostEvent&lt;threadToSignal&gt;(<span style="color:#00D">1</span>); <span style="color:#777">// Посылаем сигнал какой-то другой задаче</span>
        test ++ ;
    }
 <span style="color:#088;font-weight:bold">private</span>:
    <span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> test ;
};

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">myTasker</span>;
<span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">constexpr</span> TargetThread targetThread;
<span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">constexpr</span> Thread1&lt;myTasker, targetThread&gt; myThread1;
<span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">constexpr</span> Thread2&lt;myTasker, targetThread&gt; myThread2;</code></pre>
</div>
</div>
<div class="paragraph">
<p>И настроим таймера для задач.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">using</span> MyThread1Timer = TaskerTimer&lt;myThread1, <span style="color:#00D">1</span><span style="color:#D20">'0</span><span style="color:#40E">00</span>UL,
                                   <span style="color:#00D">1001</span>UL, <span style="color:#777">// time in ms</span>
                                   <span style="color:#00D">1</span>,
                                   myTasker&gt;;

<span style="color:#088;font-weight:bold">using</span> MyThread2Timer = TaskerTimer&lt;myThread2, <span style="color:#00D">1</span><span style="color:#D20">'0</span><span style="color:#40E">00</span>UL,
                                   <span style="color:#00D">1000</span>UL, <span style="color:#777">// time in ms</span>
                                   <span style="color:#00D">1</span>,
                                   myTasker&gt;;

<span style="color:#088;font-weight:bold">using</span> tRtosTimerService = TaskerTimerService&lt;myTasker, MyThread1Timer, MyThread2Timer&gt;;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ну и все и запускаем&#8230;&#8203;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Img/RunTasks.gif" alt="RunTasks">
</div>
</div>
<div class="paragraph">
<p>Все лежит в Github: <a href="https://github.com/lamer0k/CortexLib/tree/master/rtos">Исходный код</a>. Можно просто папку открыть в Clion.</p>
</div>
<div class="paragraph">
<p>А тут можно посмотреть <a href="https://yadi.sk/d/5__yVUbRLWOgLw">Полный код с примером под IAR 8.40.2</a></p>
</div>
</div>
</div>
<h1 id="_заключение" class="sect0">Заключение</h1>
<div class="paragraph">
<p>4 задачи моргания светодоидом + сам планировщик занимает 564 байт кода + 14 байт константных данных и 18 байт ОЗУ без оптимизации.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-left valign-top">ro code</th>
<th class="tableblock halign-left valign-top">ro data</th>
<th class="tableblock halign-left valign-top">rw data</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">taskerschedule.cpp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">508</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">interrupthandlers.s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>При включенной оптимизации, размер кода уменьшается на 120 байта.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-left valign-top">ro code</th>
<th class="tableblock halign-left valign-top">ro data</th>
<th class="tableblock halign-left valign-top">rw data</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">taskerschedule.cpp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">388</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">interrupthandlers.s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-06-09 00:48:48 +0500
</div>
</div>
</body>
</html>